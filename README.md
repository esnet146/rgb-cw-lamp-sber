# rgb-cw-lamp-sber
Прошивка умной лампочки от Сбера на модуле WBLC9 (чип BK7231T) и драйвере BP1658

Предназначена для работы из приложения сбера или через приложение от TUYA https://play.google.com/store/apps/details?id=com.tuya.smartlife&hl=ru&gl=US 

После прошивки ( основанной на тасмота ) может работать c MQTT брокером и управлятся локально из Home Assitaint.

Программа для прошивки под Питон https://github.com/OpenBekenIOT/hid_download_py

Или просто windows приложение https://github.com/openshwprojects/OpenBK7231T/blob/master/bk_writer1.60.zip

Прошивки и подробные инструкции от автора тут: https://github.com/openshwprojects/OpenBK7231T_App

Открываем релизы, скачиваем UA файл под чип BK7231T

![image](https://user-images.githubusercontent.com/64173457/195286727-aeb4b799-60ca-4d8e-a934-6c399074276c.png)

Например https://github.com/openshwprojects/OpenBK7231T_App/releases/download/1.12.103/OpenBK7231T_UA_1.12.103.bin


Упаковка и маркировка

![msg1652874704-36669](https://user-images.githubusercontent.com/64173457/195269552-a5eb8cb0-0087-45f1-ba43-0c86f336c0cf.jpg)
![msg1652874704-36670](https://user-images.githubusercontent.com/64173457/195269545-0e5f60ec-3beb-40f9-8329-870e8e616069.jpg)
Описание модуля https://developer.tuya.com/en/docs/iot/wblc9-module-datasheet?id=K9hgglry2jp5h

Разборка:

Нагреваем феном паяльной станции обод лампы в месте крепления плафона с корпусом:

![msg1652874704-36673](https://user-images.githubusercontent.com/64173457/195270192-eeff047d-b255-499a-8e21-6a8ca91aeda2.jpg)
![msg1652874704-36671](https://user-images.githubusercontent.com/64173457/195270193-815748e8-3d77-401a-bb05-dc3d99a3e8ef.jpg)

Пока горяченькая берем одной рукой за корпус, другой за плафон и раскачивая отсоединяем плафон от корпуса ( разламывать не нужно, ковырять ножиками тоже! )

Снимаем центральный контакт цоколя

![msg1652874704-36676](https://user-images.githubusercontent.com/64173457/195271157-b295cb1f-8b05-4677-a5ba-f25deebadec6.jpg)

Снимаем резьбовой контакт цоколя, аккуратно тупын ножом сдвигая по кругу, потихоньку, ничего не сгибая и прорезая

![msg1652874704-36677](https://user-images.githubusercontent.com/64173457/195271650-26155e1a-7540-4149-a99d-919bc20b6f52.jpg)
![msg1652874704-36678](https://user-images.githubusercontent.com/64173457/195271686-ac7d7af9-5cf1-4899-b422-4e10750d9535.jpg)

срезаем заводской клей с верхней части светодиодной матрицы, не царапая подложку матрицы, без фанатизма, главное - освобоить самый край матрицы у корпуса лампы ( ну и красоту навести)

![msg1652874704-36680](https://user-images.githubusercontent.com/64173457/195272100-3097d64a-bc9c-4620-afdb-38c3f51a8509.jpg)

аккуратно вставляем внутрь лампы отвертку, достаточно тонкую и крепкую. Главное - не оторвать ничего внутри, берем конструкцию в руки, упираем отвертку в край матрицы и выталкиваем весь пакет из корпуса преодолевая сопротивление остатков клея и фиксатора матрицы в радиаторе корпуса лампы. Берегите руки, не проткните их отверткой, они еще пригодятся. не сломайте ничего внутри лампы и светодиодную матрицу, они нужны.

![msg1652874704-36679](https://user-images.githubusercontent.com/64173457/195272932-6ba335be-289e-449d-863a-095b2abf1c61.jpg)

Отсоединяем матрицу от платы управлениея ( необязательно, но дальше работать будет удобнее )

![msg1652874704-36681](https://user-images.githubusercontent.com/64173457/195274072-acb08f37-1176-482f-974e-a5f91d4448f4.jpg)

Облуживаем точки подключения

![msg1652874704-36685](https://user-images.githubusercontent.com/64173457/195281837-057672c5-c5df-4d7d-8765-f21e7ce253c5.jpg)

Припаиваем внешнее питание ( пока не подключаем, нужно будет уже при работе с прошивкой )

![msg1652874704-36682](https://user-images.githubusercontent.com/64173457/195282183-be4c12bc-4ef1-4572-8237-c9792ba913d1.jpg)

Далее определитесь: если нужно сохранить возможность вернуть обратно возможность работы с облаком - нужен бэкап внутренней флешки чипа и программатор SPI. Например совсем не дорогой CH341A. Другой вариант - сразу безвозратно прошить для работы через MQTT брокер и забыть навсегда про tuya. Тогда нужен просто любой UART и можно пропустить все что связано с чтением, а перейти сразу к прошивке.

Бэкап внутренней памяти:

Берем SPI программатор

![image](https://user-images.githubusercontent.com/64173457/195288277-49069350-1e15-4f58-a919-fc451d045431.png)

Подключаем к модулю 4 провода шины SPI, CEN и сразу первый UART

![image](https://user-images.githubusercontent.com/64173457/195291562-6e441003-2683-44fb-862b-d4bfd16b6061.png)

схема TP и контактов

![photo_5345780381711974440_y](https://user-images.githubusercontent.com/64173457/195275589-a5aa3367-8504-4cd9-802f-dfdd666ca6b7.jpg)





